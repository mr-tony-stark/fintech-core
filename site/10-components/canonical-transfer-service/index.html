
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the Storo payments nucleus — architecture, specs, ops.">
      
      
      
        <link rel="canonical" href="https://your-org.github.io/fintech-core/10-components/canonical-transfer-service/">
      
      
        <link rel="prev" href="../../00-overview/architecture-decisions/ADR-0003-contracts-first/">
      
      
        <link rel="next" href="../rail-gateway-template/">
      
      
      <link rel="icon" href="../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Canonical transfer service - Storo Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../styles/brand.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#canonical-transfer-service-cts-system-design-document" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Storo Docs" class="md-header__button md-logo" aria-label="Storo Docs" data-md-component="logo">
      
  <img src="../../assets/images/favicon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Storo Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Canonical transfer service
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="custom"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="custom"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/your-org/fintech-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    your-org/fintech-core
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../00-overview/" class="md-tabs__link">
          
  
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
  Components

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../10-mvp/" class="md-tabs__link">
        
  
  
    
  
  MVP

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../20-specs/events/" class="md-tabs__link">
          
  
  
  Specs

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../30-diagrams/component-nucleus/" class="md-tabs__link">
          
  
  
  Diagrams

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../40-ops/runbooks/" class="md-tabs__link">
          
  
  
  Ops

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../60-infra/aws-infra/" class="md-tabs__link">
          
  
  
  Infra

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../50-repo-structure/multi-repo-architecture/" class="md-tabs__link">
          
  
  
  Repo Structure

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../sprint-001/" class="md-tabs__link">
          
  
  
  Sprints

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../90-templates/TEMPLATE-component/" class="md-tabs__link">
          
  
  
  Templates

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Storo Docs" class="md-nav__button md-logo" aria-label="Storo Docs" data-md-component="logo">
      
  <img src="../../assets/images/favicon.svg" alt="logo">

    </a>
    Storo Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/your-org/fintech-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    your-org/fintech-core
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storo Documentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00-overview/nucleus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storo Nucleus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00-overview/glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00-overview/storo-vs-mojaloop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Storo Nucleus vs Mojaloop Hub - Visual Contrast
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture Decisions
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Architecture Decisions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00-overview/architecture-decisions/ADR-0001-events-outbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0001: Outbox Pattern Mandatory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00-overview/architecture-decisions/ADR-0002-double-entry-ledger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0002: Ledger is Double-Entry and Append-Only
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../00-overview/architecture-decisions/ADR-0003-contracts-first/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-0003: Contracts-First via storo-specs Repo
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Canonical transfer service
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Canonical transfer service
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#canonical-transfer-service-cts-system-design-document" class="md-nav__link">
    <span class="md-ellipsis">
      Canonical Transfer Service (CTS) — System Design Document
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Canonical Transfer Service (CTS) — System Design Document">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      1. Introduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-background-context" class="md-nav__link">
    <span class="md-ellipsis">
      2. Background &amp; Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-functional-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      3. Functional Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-non-functional-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      4. Non-Functional Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-architecture-design" class="md-nav__link">
    <span class="md-ellipsis">
      5. Architecture &amp; Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-data-model" class="md-nav__link">
    <span class="md-ellipsis">
      6. Data Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Data Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transfers" class="md-nav__link">
    <span class="md-ellipsis">
      Transfers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transfer-events" class="md-nav__link">
    <span class="md-ellipsis">
      Transfer Events
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outbox-transfers" class="md-nav__link">
    <span class="md-ellipsis">
      Outbox Transfers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotency" class="md-nav__link">
    <span class="md-ellipsis">
      Idempotency
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routing-cache-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Routing Cache (optional)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-interfaces-contracts" class="md-nav__link">
    <span class="md-ellipsis">
      7. Interfaces &amp; Contracts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-operational-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      8. Operational Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      9. Testing Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-risks-trade-offs-and-open-questions" class="md-nav__link">
    <span class="md-ellipsis">
      10. Risks, Trade-offs, and Open Questions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11-appendix" class="md-nav__link">
    <span class="md-ellipsis">
      11. Appendix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-pilot-requirements-aws-serverless-option" class="md-nav__link">
    <span class="md-ellipsis">
      12. Pilot Requirements &amp; AWS Serverless Option
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authoritative-input-spec" class="md-nav__link">
    <span class="md-ellipsis">
      Authoritative Input Spec
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      🔄 State Machine
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#failure-modes-retries" class="md-nav__link">
    <span class="md-ellipsis">
      🚨 Failure Modes &amp; Retries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#observability" class="md-nav__link">
    <span class="md-ellipsis">
      📊 Observability
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security" class="md-nav__link">
    <span class="md-ellipsis">
      🔐 Security
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#runbooks" class="md-nav__link">
    <span class="md-ellipsis">
      📘 Runbooks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="📘 Runbooks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#open-questions-next-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Open Questions &amp; Next Decisions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-iteration-plan-2-weeks" class="md-nav__link">
    <span class="md-ellipsis">
      Next Iteration Plan (2 weeks)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decisions-ready-to-adopt" class="md-nav__link">
    <span class="md-ellipsis">
      Decisions (ready to adopt)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-map-whowhatwhen" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation map (who/what/when)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — Template
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-oppwa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — OPPWA (Card / Tokenized Payments)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-zimswitch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — Zimswitch (Card / ISO 8583 via OPPWA)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-usdc-algo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — USDC on Algorand
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-ecocash/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — EcoCash (Mobile Money, ZW)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-mtn-momo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — MTN MoMo (Mobile Money)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-airtel-momo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — Airtel Money (Mobile Money)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-payshap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — PayShap (ZA Instant Proxy Payments)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-eft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — EFT (BankservAfrica Batch)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rail-gateway-rtgs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rail Gateway — RTGS (High-Value)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ledger-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ledger Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compliance-screening/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compliance Screening Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../directory-routing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Directory &amp; Routing Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reconciliation-returns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reconciliation &amp; Returns Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event-bus-outbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Bus &amp; Outbox Infrastructure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operator-console/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Operator Console
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../platform-base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Platform/Base Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../regulatory-reporting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Regulatory Reporting Service
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../10-mvp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MVP
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Specs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Specs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Specifications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/api-canonical-transfer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Canonical Transfer API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/fixtures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Golden Fixtures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/posting-rules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Posting Rules (Expanded)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/data-retention-pii/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Retention &amp; PII Handling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/chart-of-accounts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chart of Accounts (Storo)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/risk-limits/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Risk Limits &amp; KYC Tiers (ZA/ZW)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/regulatory-reporting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Regulatory Reporting (ZA/ZW)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/fx-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FX Policy (USD/ZAR/ZWL)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-specs/tax-vat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tax &amp; VAT (ZA/ZW)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Diagrams
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Diagrams
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/component-nucleus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Component: Nucleus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/lifecycle-state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transfer Lifecycle
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/sequence-submit-usdc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequence: Submit USDC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/sequence-return-oppwa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequence: Return (OPPWA)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/recon-matching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reconciliation Matching
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/sequence-submit-payshap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequence: Submit PayShap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/sequence-eft-batch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequence: EFT Batch
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/sequence-stk-ecocash/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequence: EcoCash STK Prompt
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../30-diagrams/sequence-bop-reporting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sequence: BoP Reporting Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ops
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Ops
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../40-ops/runbooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runbooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../40-ops/observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../40-ops/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../40-ops/closing-the-books/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Closing the Books (Ops Runbook)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../40-ops/regulatory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Regulatory Ops (STR/CTR, BoP)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Infra
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Infra
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../60-infra/aws-infra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Infrastructure Blueprint (Storo Nucleus)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Repo Structure
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Repo Structure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../50-repo-structure/multi-repo-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi‑Repo Architecture (Storo)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../50-repo-structure/ci-cd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CI/CD Standard (per service)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../50-repo-structure/local-dev/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Local Development (storo‑devstack)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../50-repo-structure/release-strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Sprints
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Sprints
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sprint-001/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sprint 001 – Kickoff
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../70-sprints/epics-and-stories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Epics &amp; Stories Status
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Templates
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Templates
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../90-templates/TEMPLATE-component/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TEMPLATE component
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../90-templates/TEMPLATE-sequence.mmd" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    None
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../90-templates/TEMPLATE-state.mmd" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    None
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../90-templates/TEMPLATE-adr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-XXXX:
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/your-org/fintech-core/edit/master/docs/10-components/canonical-transfer-service.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>Canonical transfer service</h1>

<h2 id="canonical-transfer-service-cts-system-design-document">Canonical Transfer Service (CTS) — System Design Document<a class="headerlink" href="#canonical-transfer-service-cts-system-design-document" title="Permanent link">&para;</a></h2>
<p>The Canonical Transfer Service (CTS) is the front door and conductor of Storo. It provides a single API for creating and managing transfers, normalizes requests into a canonical format, enforces idempotency, screens entities, routes transfers, and emits domain events.</p>
<hr />
<h3 id="1-introduction">1. Introduction<a class="headerlink" href="#1-introduction" title="Permanent link">&para;</a></h3>
<ul>
<li>Purpose: Define an actionable, auditable, and operable System Design for CTS.</li>
<li>Scope: CTS handles submission and tracking of transfers; it does not execute rail-specific protocols directly, compute ledger postings, or perform KYC—those are delegated to Gateways, Ledger, and Compliance.</li>
<li>Audience: Backend engineers, SRE/Platform, Security/Compliance, Product.</li>
</ul>
<hr />
<h3 id="2-background-context">2. Background &amp; Context<a class="headerlink" href="#2-background-context" title="Permanent link">&para;</a></h3>
<ul>
<li>Multi-tenant, regulated data, event-driven architecture with transactional outbox and eventual consistency for downstream consumers.</li>
<li>CTS upstream: clients/integrators. Downstream: Compliance, Directory &amp; Routing, Rail Gateways, Ledger (via events), Observability stack.</li>
</ul>
<p>Mermaid Context (C4 Level 1)
<pre class="mermaid"><code>graph TD
  subgraph Clients
    A[Client Apps / Integrators]
  end

  subgraph Storo Core
    B[CTS API]
    C[Compliance Service]
    D[Directory &amp; Routing]
    E[Rail Gateways]
    F[Ledger Service]
    G[(OLTP DB)]
    H[[Event Bus]]
    I[[Observability: Metrics/Logs/Tracing]]
  end

  A -- HTTPS sync --&gt; B
  B -- screen sync --&gt; C
  B -- route sync --&gt; D
  B -- persist sync --&gt; G
  B -- events async --&gt; H
  H -- accepted/settled async --&gt; B
  H -- postings async --&gt; F
  B -- telemetry --&gt; I</code></pre></p>
<p>Assumptions/Constraints
- Eventual consistency for downstream consumers; synchronous path returns latest known state.
- Per-tenant authentication and authorization.
- Exactly-once event publishing via transactional outbox.
- PII encrypted at rest; PII exclusion in logs.</p>
<hr />
<h3 id="3-functional-requirements">3. Functional Requirements<a class="headerlink" href="#3-functional-requirements" title="Permanent link">&para;</a></h3>
<ul>
<li>Accept API requests: <code>POST /transfers</code>, <code>GET /transfers/:id</code>.</li>
<li>Deduplicate via idempotency key + request body hash.</li>
<li>Validate and normalize into canonical schema.</li>
<li>Pre-screen entities with Compliance.</li>
<li>Route via Directory &amp; Routing.</li>
<li>Persist transfers and lifecycle state.</li>
<li>Emit events: <code>transfers.initiated</code>, <code>transfers.submitted.&lt;rail&gt;</code> and consume <code>accepted/settled/returned/failed</code>.</li>
</ul>
<p>API contracts (summary)</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Required Headers</th>
<th>Success</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/transfers</td>
<td>Authorization, Idempotency-Key, X-Canonical-Version?</td>
<td>201 with resource or 200 on idempotent replay</td>
<td>Request validated against canonical model</td>
</tr>
<tr>
<td>GET</td>
<td>/transfers/:id</td>
<td>Authorization</td>
<td>200</td>
<td>Returns transfer details + timeline</td>
</tr>
</tbody>
</table>
<p>Canonical Request (excerpt)
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tnt_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;intent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PUSH&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100.00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;currency&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;USD&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;payer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WALLET&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;payer-abc&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;payee&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WALLET&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;payee-xyz&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;externalRef&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;client-789&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;purpose&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;invoice-42&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<hr />
<h3 id="4-non-functional-requirements">4. Non-Functional Requirements<a class="headerlink" href="#4-non-functional-requirements" title="Permanent link">&para;</a></h3>
<p>Prod targets</p>
<table>
<thead>
<tr>
<th>Category</th>
<th>Target</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Performance</td>
<td>Total p99 ≤ 2.5s; ingress→screen (≤800ms), screen→route (≤400ms), route→submit (≤1.5s)</td>
<td>Timeouts enforced per integration</td>
</tr>
<tr>
<td>Availability</td>
<td>99.95% monthly SLO; error budget 21.6m/mo</td>
<td>Excludes third-party outages beyond retry budget</td>
</tr>
<tr>
<td>Throughput</td>
<td>Baseline 200 TPS; burst 1,000 TPS (5 min)</td>
<td>HPA + queue smoothing</td>
</tr>
<tr>
<td>Scalability</td>
<td>Horizontal scale by stateless API; partition by tenantId/transferId</td>
<td>Stickiness not required</td>
</tr>
<tr>
<td>Security &amp; Privacy</td>
<td>OAuth2 client-cred or HMAC per tenant; TLS 1.2+; PII encrypted at rest</td>
<td>Logs redact PII</td>
</tr>
<tr>
<td>Reliability</td>
<td>Idempotency (24h TTL); transactional outbox with retries; DLQ</td>
<td>Exactly-once publish semantics</td>
</tr>
<tr>
<td>Compliance/Audit</td>
<td>Immutable events; correlation IDs; retention ≥ 7 years (configurable)</td>
<td>WORM storage optional</td>
</tr>
</tbody>
</table>
<p>Pilot targets (20 merchants, 100 tx/merchant/day ≈ 2k/day)</p>
<table>
<thead>
<tr>
<th>Category</th>
<th>Target</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Performance</td>
<td>p95 ≤ 2.5s at ≤ 10 TPS burst</td>
<td>Serverless/Lambda timeouts sized accordingly</td>
</tr>
<tr>
<td>Availability</td>
<td>99.9% monthly SLO</td>
<td>Single-region acceptable for pilot</td>
</tr>
<tr>
<td>Throughput</td>
<td>≈ 0.023 TPS avg (2k/day); bursts ≤ 10 TPS</td>
<td>Sized for lunchtime peaks</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="5-architecture-design">5. Architecture &amp; Design<a class="headerlink" href="#5-architecture-design" title="Permanent link">&para;</a></h3>
<p>5.1 Container (C4 Level 2)
<pre class="mermaid"><code>graph TD
  subgraph CTS
    API[API Layer / Web]
    CMD[Command Orchestrator]
    NORM[Canonical Normalizer]
    COMP[Compliance Adapter]
    ROUTE[Routing Adapter]
    SUB[Submission Publisher]
    STATE[State Manager]
    OUTBOX[Outbox Worker]
    READ[Read Model / Projections]
    DB[(OLTP DB)]
  end

  BUS[[Event Bus]]
  OBS[[Metrics/Logs/Tracing]]
  GW[Rail Gateways]
  CMP[Compliance]
  DIR[Directory &amp; Routing]

  API --&gt; CMD
  CMD --&gt; NORM
  CMD --&gt; COMP
  CMD --&gt; ROUTE
  CMD --&gt; STATE
  STATE --&gt; DB
  SUB --&gt; OUTBOX
  OUTBOX --&gt; BUS
  BUS --&gt; STATE
  API --&gt; READ
  READ --&gt; DB

  COMP --- CMP
  ROUTE --- DIR
  SUB --- GW

  API -. telemetry .-&gt; OBS
  OUTBOX -. telemetry .-&gt; OBS</code></pre></p>
<p>Sync vs Async and Backpressure
- Sync: API→Compliance, API→Directory, DB writes.
- Async: Outbox→Event Bus→Gateways; inbound events→STATE.
- Backpressure: rate limiting at API, bounded outbox worker concurrency, consumer lag alerts.</p>
<p>Amount precision and rounding
- Store monetary values as <code>NUMERIC(20,8)</code>; define per-currency scale (e.g., USD scale=2).
- Rounding mode: bankers rounding (round half to even) when converting to rail decimals.
- Validate min/max per currency; reject out-of-range with 400.</p>
<p>End-user considerations (double/triple entry)
- Each merchant transfer often involves an end user (payer). Model end-user references (<code>endUserRef</code>) in the canonical payload where applicable.
- For accounting that affects multiple ledgers (merchant wallet, end-user wallet, fees/taxes), ensure events carry sufficient references to support downstream double/triple-entry postings in the Ledger service.
- CTS remains canon/orchestrator and does not compute postings, but must not drop identifiers necessary for downstream accounting integrity.</p>
<p>5.2 Component (C4 Level 3) — Inside CTS
<pre class="mermaid"><code>graph TD
  subgraph API Layer
    R[Request Validation]
    I[Idempotency Middleware]
    Q[Rate Limiter]
  end
  subgraph Orchestration
    SAGA[Command Orchestrator Saga]
    MAP[Canonical Model Normalizer]
  end
  subgraph Integrations
    CBA[Compliance Client CB/Retry]
    DRC[Directory Client Cache]
    PUB[Submission Publisher]
  end
  subgraph Persistence
    SM[State Machine]
    OB[Outbox Table]
    RM[Read Projections]
  end

  Q --&gt; I --&gt; R --&gt; SAGA --&gt; MAP
  SAGA --&gt; CBA
  SAGA --&gt; DRC
  SAGA --&gt; SM
  SM --&gt; OB
  PUB --&gt; OB
  RM --&gt; SM
</code></pre></p>
<p>5.3 Sequence Diagrams</p>
<p>Happy Path (USDC) — non-blocking settlement
<pre class="mermaid"><code>sequenceDiagram
  autonumber
  participant Client
  participant API as CTS/API
  participant Cmp as Compliance
  participant Dir as Directory
  participant DB as CTS/DB
  participant OB as OutboxWorker
  participant Bus as EventBus
  participant GW as Gateway(USDC)

  Client-&gt;&gt;API: POST /transfers {Idempotency-Key, Authorization}
  API-&gt;&gt;API: validate + canonicalize (hash, X-Canonical-Version)
  API-&gt;&gt;Cmp: screen(payer,payee) [timeout 800ms, 2x retry]
  Cmp--&gt;&gt;API: allow
  API-&gt;&gt;Dir: route(intent, payee) [timeout 400ms]
  Dir--&gt;&gt;API: rail=usdc, endpoint
  API-&gt;&gt;DB: begin tx
  DB--&gt;&gt;API: insert transfer(state=SUBMITTED)
  DB--&gt;&gt;API: insert outbox(event=submitted.usdc)
  API--&gt;&gt;DB: commit
  API--&gt;&gt;Client: 201 Location:/transfers/:id {transferId, state: SUBMITTED, requestId}
  OB-&gt;&gt;Bus: publish events.transfers.submitted.usdc (exp backoff)
  Bus--&gt;&gt;GW: deliver
  GW--&gt;&gt;Bus: events.transfers.accepted
  Bus--&gt;&gt;API: accepted → update state
  GW--&gt;&gt;Bus: events.transfers.settled
  Bus--&gt;&gt;API: settled → update projections
</code></pre></p>
<p>Duplicate Submission
<pre class="mermaid"><code>sequenceDiagram
  participant Client
  participant API as CTS/API
  participant DB as CTS/DB
  Client-&gt;&gt;API: POST /transfers {Idempotency-Key}
  API-&gt;&gt;DB: lookup (tenantId, Idempotency-Key, bodyHash)
  alt match
    DB--&gt;&gt;API: existing transferId (same hash)
    API--&gt;&gt;Client: 200 existing resource (etag/version)
  else conflict
    DB--&gt;&gt;API: key exists with different hash
    API--&gt;&gt;Client: 409 IdempotencyConflict { priorTransferId, priorBodyHash }
  end</code></pre></p>
<p>Compliance Deny
<pre class="mermaid"><code>sequenceDiagram
  participant Client
  participant API as CTS/API
  participant Cmp as Compliance
  Client-&gt;&gt;API: POST /transfers
  API-&gt;&gt;Cmp: screen
  Cmp--&gt;&gt;API: deny(reasonCode)
  API--&gt;&gt;Client: 422 EntityDenied {reasonCode, requestId}</code></pre></p>
<p>Routing Unavailable
<pre class="mermaid"><code>sequenceDiagram
  participant Client
  participant API as CTS/API
  participant Dir as Directory
  Client-&gt;&gt;API: POST /transfers
  API-&gt;&gt;Dir: route
  note over API,Dir: timeout 400ms, no fallback
  API--&gt;&gt;Client: 502 RoutingUnavailable {retryAfter: 5s}</code></pre></p>
<p>Outbox Retry &amp; DLQ
<pre class="mermaid"><code>sequenceDiagram
  participant OB as OutboxWorker
  participant Bus as EventBus
  OB-&gt;&gt;Bus: publish
  alt failure
    OB-&gt;&gt;OB: attempts++ backoff(1s→5s→30s→2m→10m→1h)
  else success
    OB-&gt;&gt;OB: mark SENT
  end
  note over OB: DLQ after N=10 attempts (poison)</code></pre></p>
<p>5.4 State Machine
<pre class="mermaid"><code>stateDiagram-v2
  [*] --&gt; INITIATED
  INITIATED --&gt; SUBMITTED: route ok + persisted
  SUBMITTED --&gt; ACCEPTED: events.transfers.accepted
  ACCEPTED --&gt; SETTLED: events.transfers.settled
  ACCEPTED --&gt; RETURNED: events.transfers.returned
  SUBMITTED --&gt; FAILED: submission failed (non-retryable)
  INITIATED --&gt; FAILED: validation/compliance deny
  SETTLED --&gt; [*]
  RETURNED --&gt; [*]
  FAILED --&gt; [*]</code></pre></p>
<p>5.5 Data Flow
<pre class="mermaid"><code>flowchart LR
  Ingress[HTTP Ingress] --&gt; Validate[Validate/Normalize]
  Validate --&gt; Persist[Persist Write Model]
  Persist --&gt; Outbox[Write Outbox]
  Outbox --&gt; Bus[Event Bus]
  Bus --&gt; Proj[Read Model Projections]
  Proj --&gt; API[GET /transfers/:id]</code></pre></p>
<p>5.6 Deployment View
<pre class="mermaid"><code>graph TD
  subgraph k8s-cluster
    apiPod[cts-api Deployment]
    obPod[cts-outbox Worker]
    sidecar[otel sidecar]
  end
  hpa[HPA policy: target 70% CPU/qps]
  db[(Primary/Replica OLTP DB)]
  topics[[Kafka Topics: events.transfers - 12 partitions]]
  secrets[[Secrets Manager]]
  envoy[[Envoy/Ingress]]

  envoy --&gt; apiPod
  apiPod --&gt; db
  obPod --&gt; db
  apiPod --&gt; topics
  obPod --&gt; topics
  apiPod --&gt; sidecar
  obPod --&gt; sidecar
  apiPod --&gt; secrets
  obPod --&gt; secrets
  hpa -.-&gt; apiPod
  hpa -.-&gt; obPod
</code></pre></p>
<p>5.7 Key Design Topics (ADR-style)</p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Decision</th>
<th>Alternatives</th>
<th>Rationale</th>
<th>Consequences</th>
</tr>
</thead>
<tbody>
<tr>
<td>Idempotency</td>
<td><code>Idempotency-Key</code> + SHA256(normalized body) unique per tenant; TTL 24h</td>
<td>Key-only; body-only; longer TTL</td>
<td>Prevents divergent bodies on same key; caps storage</td>
<td>Store hash; shard hot tenants</td>
</tr>
<tr>
<td>Outbox Pattern</td>
<td>Same-DB transactional outbox; ordered per <code>transferId</code>; backoff 1s→5s→30s→2m→10m→1h; DLQ at 10</td>
<td>Separate queue; exactly-once Kafka</td>
<td>Simpler atomicity; avoids dual-write</td>
<td>Worker lag can grow → monitor/autoscale</td>
</tr>
<tr>
<td>Routing</td>
<td>Cache TTL 5m; negative cache 30s; deterministic rules; quirks in gateways</td>
<td>Longer TTL</td>
<td>Balanced freshness vs cost</td>
<td>Possible staleness → admin bust</td>
</tr>
<tr>
<td>Multitenancy</td>
<td>Row-level scope by <code>tenantId</code>; per-tenant quotas; per-tenant secrets</td>
<td>DB schemas per tenant</td>
<td>Simpler ops; shared pool</td>
<td>Strong tenancy guard required</td>
</tr>
<tr>
<td>Schema Evolution</td>
<td>Canonical SemVer; <code>X-Canonical-Version</code>; events <code>envelope.v</code> (BACKWARD)</td>
<td>Ad-hoc</td>
<td>Predictable upgrades</td>
<td>Maintain registry and migrations</td>
</tr>
<tr>
<td>Consistency</td>
<td>Non-blocking settlement; POST 201/200 with <code>state=SUBMITTED</code> + Location</td>
<td>Synchronous settlement</td>
<td>Lower latency; simpler SLAs</td>
<td>Clients must poll/subscribe</td>
</tr>
<tr>
<td>Concurrency (OCC)</td>
<td><code>transfers.version</code> BIGINT; <code>WHERE transferId AND version</code>; bump version</td>
<td>Pessimistic locks</td>
<td>Avoids locks; suits serverless</td>
<td>409s/retries on conflicts</td>
</tr>
<tr>
<td>Observability</td>
<td>W3C traceparent; metrics by <code>tenantId</code>,<code>rail</code>,<code>state</code>; PII-safe logs</td>
<td>None</td>
<td>Traceability and SLOs</td>
<td>Watch label cardinality</td>
</tr>
<tr>
<td>Backpressure</td>
<td>Token-bucket per tenant; bounded workers; circuit breakers</td>
<td>Unlimited</td>
<td>Protects core systems</td>
<td>Graceful shedding under load</td>
</tr>
<tr>
<td>Error Taxonomy</td>
<td>4xx (validation/deny), 409 (idempotency/OCC), 429 (rate limits), 5xx (internal/502 routing)</td>
<td>Loose mapping</td>
<td>Clear client behavior</td>
<td>Easier debugging and SLAs</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="6-data-model">6. Data Model<a class="headerlink" href="#6-data-model" title="Permanent link">&para;</a></h3>
<p>Tables</p>
<h4 id="transfers">Transfers<a class="headerlink" href="#transfers" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Nullable</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>transferId</td>
<td>UUID</td>
<td>no</td>
<td>PK</td>
</tr>
<tr>
<td>tenantId</td>
<td>TEXT</td>
<td>no</td>
<td>partition key</td>
</tr>
<tr>
<td>payer</td>
<td>JSONB</td>
<td>no</td>
<td>PII encrypted-at-rest</td>
</tr>
<tr>
<td>payee</td>
<td>JSONB</td>
<td>no</td>
<td>PII encrypted-at-rest</td>
</tr>
<tr>
<td>amount_value</td>
<td>NUMERIC(20,8)</td>
<td>no</td>
<td></td>
</tr>
<tr>
<td>amount_currency</td>
<td>CHAR(3)</td>
<td>no</td>
<td>ISO-4217 or pseudo</td>
</tr>
<tr>
<td>rail</td>
<td>TEXT</td>
<td>no</td>
<td>e.g., usdc, zimswitch</td>
</tr>
<tr>
<td>intent</td>
<td>TEXT</td>
<td>no</td>
<td>AUTH</td>
</tr>
<tr>
<td>externalRef</td>
<td>TEXT</td>
<td>yes</td>
<td>client reference</td>
</tr>
<tr>
<td>state</td>
<td>TEXT</td>
<td>no</td>
<td>INITIATED</td>
</tr>
<tr>
<td>createdAt</td>
<td>TIMESTAMP WITH TZ</td>
<td>no</td>
<td></td>
</tr>
<tr>
<td>updatedAt</td>
<td>TIMESTAMP WITH TZ</td>
<td>no</td>
<td></td>
</tr>
<tr>
<td>version</td>
<td>BIGINT</td>
<td>no</td>
<td>optimistic locking counter (default 0)</td>
</tr>
</tbody>
</table>
<p>Indexes/Constraints
- PK: <code>(transferId)</code>
- IDX: <code>(tenantId, createdAt)</code>
- Unique: <code>(tenantId, externalRef)</code> nullable unique</p>
<h4 id="transfer-events">Transfer Events<a class="headerlink" href="#transfer-events" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Nullable</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>eventId</td>
<td>UUID</td>
<td>no</td>
<td>PK</td>
</tr>
<tr>
<td>transferId</td>
<td>UUID</td>
<td>no</td>
<td>FK → transfers</td>
</tr>
<tr>
<td>type</td>
<td>TEXT</td>
<td>no</td>
<td>initiated/submitted/accepted/...</td>
</tr>
<tr>
<td>payload</td>
<td>JSONB</td>
<td>no</td>
<td>envelope v=1</td>
</tr>
<tr>
<td>occurredAt</td>
<td>TIMESTAMP WITH TZ</td>
<td>no</td>
<td>event time</td>
</tr>
</tbody>
</table>
<p>Indexes
- PK: <code>(eventId)</code>
- IDX: <code>(transferId, occurredAt)</code>
- Unique: <code>(transferId, type)</code> for lifecycle uniqueness</p>
<h4 id="outbox-transfers">Outbox Transfers<a class="headerlink" href="#outbox-transfers" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Nullable</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>UUID</td>
<td>no</td>
<td>PK</td>
</tr>
<tr>
<td>eventType</td>
<td>TEXT</td>
<td>no</td>
<td>e.g., transfers.submitted.usdc</td>
</tr>
<tr>
<td>payload</td>
<td>JSONB</td>
<td>no</td>
<td>event data</td>
</tr>
<tr>
<td>state</td>
<td>TEXT</td>
<td>no</td>
<td>PENDING</td>
</tr>
<tr>
<td>attempts</td>
<td>INT</td>
<td>no</td>
<td>default 0</td>
</tr>
<tr>
<td>lastError</td>
<td>TEXT</td>
<td>yes</td>
<td>latest error</td>
</tr>
<tr>
<td>createdAt</td>
<td>TIMESTAMP WITH TZ</td>
<td>no</td>
<td></td>
</tr>
<tr>
<td>updatedAt</td>
<td>TIMESTAMP WITH TZ</td>
<td>no</td>
<td></td>
</tr>
</tbody>
</table>
<p>Indexes
- IDX: <code>(state, createdAt)</code>
- IDX: <code>(eventType)</code></p>
<h4 id="idempotency">Idempotency<a class="headerlink" href="#idempotency" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Nullable</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>tenantId</td>
<td>TEXT</td>
<td>no</td>
<td></td>
</tr>
<tr>
<td>idempotencyKey</td>
<td>TEXT</td>
<td>no</td>
<td></td>
</tr>
<tr>
<td>bodyHash</td>
<td>CHAR(64)</td>
<td>no</td>
<td>sha256</td>
</tr>
<tr>
<td>transferId</td>
<td>UUID</td>
<td>no</td>
<td></td>
</tr>
<tr>
<td>createdAt</td>
<td>TIMESTAMP WITH TZ</td>
<td>no</td>
<td>TTL policy ≥ 24h</td>
</tr>
</tbody>
</table>
<p>Indexes
- Unique: <code>(tenantId, idempotencyKey, bodyHash)</code></p>
<h4 id="routing-cache-optional">Routing Cache (optional)<a class="headerlink" href="#routing-cache-optional" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Nullable</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>key</td>
<td>TEXT</td>
<td>no</td>
<td>hashed routing tuple</td>
</tr>
<tr>
<td>value</td>
<td>JSONB</td>
<td>no</td>
<td>route details</td>
</tr>
<tr>
<td>expiresAt</td>
<td>TIMESTAMP WITH TZ</td>
<td>no</td>
<td>ttl</td>
</tr>
</tbody>
</table>
<p>Sample Rows (illustrative)
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transfers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;transferId&quot;</span><span class="p">:</span><span class="s2">&quot;a1b2&quot;</span><span class="p">,</span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span><span class="nt">&quot;amount_value&quot;</span><span class="p">:</span><span class="s2">&quot;100.00&quot;</span><span class="p">,</span><span class="nt">&quot;amount_currency&quot;</span><span class="p">:</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span><span class="nt">&quot;rail&quot;</span><span class="p">:</span><span class="s2">&quot;usdc&quot;</span><span class="p">,</span><span class="nt">&quot;intent&quot;</span><span class="p">:</span><span class="s2">&quot;PUSH&quot;</span><span class="p">,</span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="s2">&quot;SUBMITTED&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;outbox_transfers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span><span class="nt">&quot;eventType&quot;</span><span class="p">:</span><span class="s2">&quot;transfers.submitted.usdc&quot;</span><span class="p">,</span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="s2">&quot;PENDING&quot;</span><span class="p">,</span><span class="nt">&quot;attempts&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Retention
- <code>idempotency</code>: TTL 36h (GC job)
- <code>transfer_events</code>: hot in OLTP 90 days; archive to object store thereafter
- <code>outbox_transfers</code>: keep SENT 7 days; FAILED until resolved</p>
<p>Indexes and constraints (additions)</p>
<ul>
<li>
<p>Idempotency
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">ux_idempotency</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">idempotency</span><span class="p">(</span><span class="n">tenantId</span><span class="p">,</span><span class="w"> </span><span class="n">idempotencyKey</span><span class="p">,</span><span class="w"> </span><span class="n">bodyHash</span><span class="p">);</span>
<span class="c1">-- Optional partial unique within 36h window</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">ux_idempotency_window</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">idempotency</span><span class="p">(</span><span class="n">tenantId</span><span class="p">,</span><span class="w"> </span><span class="n">idempotencyKey</span><span class="p">,</span><span class="w"> </span><span class="n">bodyHash</span><span class="p">)</span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">createdAt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;36 hours&#39;</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p>ExternalRef
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">ux_transfers_externalref</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">transfers</span><span class="p">(</span><span class="n">tenantId</span><span class="p">,</span><span class="w"> </span><span class="n">externalRef</span><span class="p">)</span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">externalRef</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>

<span class="c1">-- Optionally include intent to reduce collisions</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">ux_transfers_externalref_intent</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">transfers</span><span class="p">(</span><span class="n">tenantId</span><span class="p">,</span><span class="w"> </span><span class="n">intent</span><span class="p">,</span><span class="w"> </span><span class="n">externalRef</span><span class="p">)</span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">externalRef</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p>Events uniqueness
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">ux_events_lifecycle</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">transfer_events</span><span class="p">(</span><span class="n">transferId</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="p">);</span>
<span class="c1">-- If a rail can emit multiple of the same type</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">ux_events_seq</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">transfer_events</span><span class="p">(</span><span class="n">transferId</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p>Optimistic locking
<div class="highlight"><pre><span></span><code><span class="c1">-- Column already defined: version BIGINT NOT NULL DEFAULT 0</span>
<span class="c1">-- Guarded update example</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">transfers</span>
<span class="k">SET</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">updatedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">()</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">transferId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="mi">3</span><span class="p">;</span>
</code></pre></div>
Behavior: return 409/Retry on no-row-updated for external callers; internal workers retry with jitter/backoff.</p>
</li>
</ul>
<hr />
<h3 id="7-interfaces-contracts">7. Interfaces &amp; Contracts<a class="headerlink" href="#7-interfaces-contracts" title="Permanent link">&para;</a></h3>
<p>HTTP APIs</p>
<p>POST /transfers
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/transfers</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Bearer &lt;token&gt;</span>
<span class="na">Idempotency-Key</span><span class="o">:</span> <span class="l">6f1e2...</span>
<span class="na">X-Canonical-Version</span><span class="o">:</span> <span class="l">1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
</code></pre></div>
Request
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;intent&quot;</span><span class="p">:</span><span class="s2">&quot;PUSH&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;amount&quot;</span><span class="p">:{</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;100.00&quot;</span><span class="p">,</span><span class="nt">&quot;currency&quot;</span><span class="p">:</span><span class="s2">&quot;USD&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;payer&quot;</span><span class="p">:{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;WALLET&quot;</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;payer-1&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;payee&quot;</span><span class="p">:{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;WALLET&quot;</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;payee-9&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;externalRef&quot;</span><span class="p">:</span><span class="s2">&quot;inv-42&quot;</span>
<span class="p">}</span>
</code></pre></div>
Responses
<div class="highlight"><pre><span></span><code><span class="c1">// 201 Created (first time)</span>
<span class="p">{</span><span class="nt">&quot;transferId&quot;</span><span class="p">:</span><span class="s2">&quot;a1b2&quot;</span><span class="p">,</span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="s2">&quot;SUBMITTED&quot;</span><span class="p">,</span><span class="nt">&quot;rail&quot;</span><span class="p">:</span><span class="s2">&quot;usdc&quot;</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// 200 OK (duplicate)</span>
<span class="p">{</span><span class="nt">&quot;transferId&quot;</span><span class="p">:</span><span class="s2">&quot;a1b2&quot;</span><span class="p">,</span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="s2">&quot;SUBMITTED&quot;</span><span class="p">,</span><span class="nt">&quot;rail&quot;</span><span class="p">:</span><span class="s2">&quot;usdc&quot;</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// 409 IdempotencyConflict (same key, different body)</span>
<span class="p">{</span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;IdempotencyConflict&quot;</span><span class="p">,</span><span class="nt">&quot;priorTransferId&quot;</span><span class="p">:</span><span class="s2">&quot;a1b2&quot;</span><span class="p">,</span><span class="nt">&quot;priorBodyHash&quot;</span><span class="p">:</span><span class="s2">&quot;sha256:...&quot;</span><span class="p">}</span>
</code></pre></div>
Errors
<div class="highlight"><pre><span></span><code><span class="c1">// 422 EntityDenied</span>
<span class="p">{</span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;EntityDenied&quot;</span><span class="p">,</span><span class="nt">&quot;reason&quot;</span><span class="p">:</span><span class="s2">&quot;watchlist_hit&quot;</span><span class="p">,</span><span class="nt">&quot;requestId&quot;</span><span class="p">:</span><span class="s2">&quot;r-123&quot;</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// 502 RoutingUnavailable</span>
<span class="p">{</span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;RoutingUnavailable&quot;</span><span class="p">,</span><span class="nt">&quot;retryAfter&quot;</span><span class="p">:</span><span class="s2">&quot;5s&quot;</span><span class="p">}</span>
</code></pre></div></p>
<p>Decision tree (POST /transfers)</p>
<ol>
<li>Validate request (schema, authZ)</li>
<li>On failure: 400/401/403</li>
<li>Idempotency lookup</li>
<li>Key+hash match: 200 (return existing resource)</li>
<li>Key exists, hash differs: 409 IdempotencyConflict</li>
<li>Compliance screening</li>
<li>Deny: 422 EntityDenied</li>
<li>Routing</li>
<li>Timeout/5xx: 502 RoutingUnavailable</li>
<li>Persist write model + outbox (single DB tx)</li>
<li>Success: 201 Created with <code>Location: /transfers/:id</code> and <code>state=SUBMITTED</code></li>
<li>Concurrency (optimistic lock)</li>
<li>External mutating APIs: 409 Conflict</li>
<li>Internal workers: retry with jitter/backoff</li>
</ol>
<p>GET /transfers/:id
<div class="highlight"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/transfers/a1b2</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Bearer &lt;token&gt;</span>
</code></pre></div>
Response
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;transferId&quot;</span><span class="p">:</span><span class="s2">&quot;a1b2&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="s2">&quot;SETTLED&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;timeline&quot;</span><span class="p">:[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;initiated&quot;</span><span class="p">,</span><span class="nt">&quot;at&quot;</span><span class="p">:</span><span class="s2">&quot;2025-01-01T10:00:00Z&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;submitted.usdc&quot;</span><span class="p">,</span><span class="nt">&quot;at&quot;</span><span class="p">:</span><span class="s2">&quot;2025-01-01T10:00:01Z&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;accepted&quot;</span><span class="p">,</span><span class="nt">&quot;at&quot;</span><span class="p">:</span><span class="s2">&quot;2025-01-01T10:00:02Z&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;settled&quot;</span><span class="p">,</span><span class="nt">&quot;at&quot;</span><span class="p">:</span><span class="s2">&quot;2025-01-01T10:03:00Z&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Event Contracts
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;envelope&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;eventId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;occurredAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ts&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;t1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;transferId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a1b2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;transfers.submitted.usdc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;traceparent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;00-...&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;payload&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;100.00&quot;</span><span class="p">,</span><span class="nt">&quot;currency&quot;</span><span class="p">:</span><span class="s2">&quot;USD&quot;</span><span class="p">},</span><span class="w"> </span><span class="nt">&quot;payer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;...&quot;</span><span class="p">},</span><span class="w"> </span><span class="nt">&quot;payee&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;...&quot;</span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
Canonicalization and body hash</p>
<p>Algorithm (v1):
- Normalize JSON per canonical schema version.
- Trim strings; lowercase ISO currency codes; normalize country/phone formats.
- Sort object keys lexicographically; arrays kept in submitted order unless schema defines ordering.
- Amounts: parse to decimal, scale to currency decimals (see Amount precision), serialize as string.
- Serialize with no insignificant whitespace.
- Compute <code>bodyHash = sha256(serialized)</code> and store with idempotency record.</p>
<p>Sample vector:
<div class="highlight"><pre><span></span><code><span class="c1">// input</span>
<span class="p">{</span><span class="nt">&quot;amount&quot;</span><span class="p">:{</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;100.0&quot;</span><span class="p">,</span><span class="nt">&quot;currency&quot;</span><span class="p">:</span><span class="s2">&quot;usd&quot;</span><span class="p">},</span><span class="nt">&quot;payer&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot; A &quot;</span><span class="p">}}</span>
<span class="c1">// normalized</span>
<span class="p">{</span><span class="nt">&quot;amount&quot;</span><span class="p">:{</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;100.00&quot;</span><span class="p">,</span><span class="nt">&quot;currency&quot;</span><span class="p">:</span><span class="s2">&quot;USD&quot;</span><span class="p">},</span><span class="nt">&quot;payer&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;A&quot;</span><span class="p">}}</span>
<span class="c1">// sha256</span>
<span class="s2">&quot;b0b6...&quot;</span>
</code></pre></div>
Topics
- <code>events.transfers.initiated</code>
- <code>events.transfers.submitted.&lt;rail&gt;</code> (e.g., <code>events.transfers.submitted.usdc</code>)
- Inbound: <code>events.transfers.accepted|settled|returned|failed</code></p>
<p>Ordering and dedupe
- For SNS/SQS FIFO: <code>MessageGroupId = transferId</code> to guarantee per-transfer ordering; <code>MessageDeduplicationId = eventId</code>.
- Consumers must dedupe by <code>eventId</code> and <code>(transferId,type)</code> to handle retries/replays.</p>
<p>Timeouts/SLAs
| Integration | Timeout | Retry | SLA |
|---|---|---|---|
| Compliance | 800ms | 2 with jitter | 99.9% |
| Directory | 400ms | 1 with jitter | 99.9% |
| Gateway Publish | async | backoff 1s..1h | N/A |</p>
<p>Tenant isolation &amp; quotas
- Per-tenant token-bucket rate limits (defaults: 50 rps burst, 5 rps sustained for pilot).
- Authorization scopes restrict access to <code>tenantId</code>; all queries filter by <code>tenantId</code>.
- Quota override process via config store with change audit.</p>
<p>Threat model (mini)
- IDOR on GET <code>/transfers/:id</code> → enforce tenant scope; verify <code>tenantId</code> ownership per row.
- Replay with stolen <code>Idempotency-Key</code> → pair key with bodyHash and TTL; require Authorization; optionally sign requests (HMAC).
- Message tampering on bus → server-side signing/envelope checksum; least-privilege topics; DLQ visibility restricted.</p>
<p>PII strategy
- Events carry <code>payer_ref</code>/<code>payee_ref</code> only; PII stored in encrypted columns/tables (KMS key rotation annually).
- POPIA/GDPR: support erasure by tombstoning PII fields while preserving event integrity (refs remain).</p>
<p>Schema registry &amp; compatibility
- Event envelope and payloads registered in Schema Registry; policy BACKWARD for events.
- Breaking-change process: bump <code>envelope.v</code>, dual-publish during migration window, communicate to consumers.</p>
<p>Replay &amp; re-drive
- Controlled replay from outbox or archived events; idempotent updates ensured by <code>(transferId,type)</code> uniqueness.
- Time-boxed replays with audit log entries for who/when/why.</p>
<hr />
<h3 id="8-operational-considerations">8. Operational Considerations<a class="headerlink" href="#8-operational-considerations" title="Permanent link">&para;</a></h3>
<ul>
<li>Deployment: Blue/Green or Canary via ingress weights; feature flags for risky paths.</li>
<li>Config: Environment + central config store; secret rotation via Secrets Manager.</li>
<li>Runbooks (expanded)</li>
<li>High Latency: check <code>compliance_client_latency_p95</code>, <code>directory_client_latency_p95</code>, DB CPU/IO, thread pools.</li>
<li>Stuck SUBMITTED: inspect outbox lag, worker health, DLQ; reprocess by id.</li>
<li>Idempotency Collisions: audit client keys, compare bodyHash mismatches.</li>
<li>Alerts</li>
<li><code>rate(cts_outbox_failures_total[5m]) / rate(cts_outbox_attempts_total[5m]) &gt; 0.001 for 5m</code></li>
<li><code>histogram_quantile(0.95, sum(rate(http_server_duration_seconds_bucket{route="/transfers"}[5m])) by (le)) &gt; 1.5</code></li>
<li><code>cts_consumer_lag{topic="events.transfers.*"} &gt; 5000 for 10m</code></li>
<li><code>rate(http_5xx_total[5m]) &gt; 0.01</code></li>
<li>SLO burn alerts: 2% budget burn over 1h, 5% over 6h for availability/latency SLOs</li>
<li>Capacity</li>
<li>Scale API by QPS and p95 latency; scale workers by outbox depth and publish rate; 1 partition per expected 50 TPS.</li>
</ul>
<p>Migrations
- Tooling: Flyway or Liquibase.
- Zero-downtime: expand (add nullable columns/indexes) → dual-write if needed → backfill → contract.
- Rollback: feature-flag writes; maintain backward compatible reads; revert via migrations down.</p>
<p>Runbooks (deepening)
- Poison message: locate <code>eventId</code>, inspect <code>lastError</code>, retry N with backoff, if still failing park to DLQ and open ticket; optional manual mark-SENT with signed approval.
- Hot tenant: reduce tenant-specific rate limit, shard outbox processing by <code>tenantId</code>, notify tenant of temporary caps.</p>
<hr />
<h3 id="9-testing-strategy">9. Testing Strategy<a class="headerlink" href="#9-testing-strategy" title="Permanent link">&para;</a></h3>
<ul>
<li>Unit: validators, normalizer, idempotency calculator.</li>
<li>Contract: Pact for HTTP (Compliance/Directory) and events (submitted, accepted, settled).</li>
<li>Integration: testcontainers for DB + fake services; deterministic retries.</li>
<li>E2E: happy path, duplicates, deny, routing fail, outbox DLQ.</li>
<li>Chaos: inject timeouts/circuit-open; DB failover drills.</li>
<li>Load: realistic mix (90% POST, 10% GET); 1% duplicates.</li>
</ul>
<hr />
<h3 id="10-risks-trade-offs-and-open-questions">10. Risks, Trade-offs, and Open Questions<a class="headerlink" href="#10-risks-trade-offs-and-open-questions" title="Permanent link">&para;</a></h3>
<ul>
<li>Outbox saturation → publish lag; mitigate via autoscale and partitioning.</li>
<li>Routing flaps → increased 5xx; mitigate with negative caching and backoff.</li>
<li>Tenant spikes → noisy neighbor; enforce per-tenant rate limits.</li>
<li>Schema drift → consumer breakage; enforce versioning and schema registry.</li>
</ul>
<p>Open questions and decisions are summarized at the end.</p>
<hr />
<h3 id="11-appendix">11. Appendix<a class="headerlink" href="#11-appendix" title="Permanent link">&para;</a></h3>
<ul>
<li>Glossary: CTS (Canonical Transfer Service), OLTP, DLQ, SAGA, RPO/RTO.</li>
<li>References: <code>docs/00-overview/architecture-decisions/ADR-0001-events-outbox.md</code>, <code>docs/20-specs/api-canonical-transfer.md</code>, <code>docs/30-diagrams/lifecycle-state.md</code>.</li>
</ul>
<hr />
<h3 id="12-pilot-requirements-aws-serverless-option">12. Pilot Requirements &amp; AWS Serverless Option<a class="headerlink" href="#12-pilot-requirements-aws-serverless-option" title="Permanent link">&para;</a></h3>
<p>Pilot scope and sizing (20 merchants)
- Volume: 100 transfers/merchant/day → ~2,000 transfers/day (avg ~0.023 TPS), anticipate bursts during business hours (assume 5–10 TPS peaks for 10–30 minutes).
- Reliability: ≥ 99% transfers reach terminal state with complete event trail.
- Latency: p95 ≤ 2.5s end-to-end for submit; p99 ≤ 4s under burst.
- Cost: minimize infra cost; prefer pay-per-use; keep auditability and outbox guarantees.</p>
<p>Derived sizing (pilot)
- Outbound events/transfer: ~3–4 typical → ≤ 8,000 events/day.
- Storage growth (pilot): Transfers ≤ 2k rows/day, Events ≤ 8k rows/day; negligible for 90-day hot retention.
- Network: &lt;&lt; 1 Mbps steady; minimal.</p>
<p>Serverless deployment (AWS) — Pilot option
<pre class="mermaid"><code>graph TD
  Client[Clients/POS] --&gt; APIGW[API Gateway]
  APIGW --&gt; LAPI[Lambda: CTS API]

  subgraph "Data Store (choose one)"
    RDS["RDS Proxy → Aurora Serverless v2 (PostgreSQL)"]
    DDB["DynamoDB Tables"]
  end

  LAPI --&gt;|Option A| RDS
  LAPI --&gt;|Option B| DDB

  subgraph "Outbox + Events"
    SQS["SQS Outbox Queue"]
    DDBS["DynamoDB Streams"]
    LPUB["Lambda: Outbox Publisher"]
    EBus["SNS FIFO Topic events.transfers"]
    SQSC1["SQS FIFO Consumer (Gateway)"]
    SQSC2["SQS FIFO Consumer (Ledger)"]
  end

  RDS --&gt; SQS
  DDB --&gt; DDBS
  DDBS --&gt; LPUB
  LPUB --&gt; EBus
  EBus --&gt; SQSC1
  EBus --&gt; SQSC2
  SQSC1 --&gt; RDS
  SQSC2 --&gt; DDB

  subgraph "Ops"
    SM["Secrets Manager"]
    CW["CloudWatch Logs/Metrics/Alarms"]
    XR["X-Ray Tracing"]
  end

  LAPI -.-&gt; SM
  LAPI -.-&gt; CW
  LAPI -.-&gt; XR
  LPUB -.-&gt; CW
  LCONS -.-&gt; CW
</code></pre></p>
<p>Data store options and recommendation</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Infra</th>
<th>How it maps to SDD</th>
<th>Pros</th>
<th>Cons</th>
<th>Pilot recommendation</th>
</tr>
</thead>
<tbody>
<tr>
<td>A. Aurora Serverless v2 + RDS Proxy</td>
<td>API Gateway + Lambda + RDS Proxy + Aurora Pg</td>
<td>Keeps OLTP DB and transactional outbox exactly as designed (same-DB tx).</td>
<td>Minimal code changes; strong ACID; SQL familiarity; easy path to prod scale.</td>
<td>Aurora min ACU cost even when idle; Lambda needs RDS Proxy to avoid connection storms.</td>
<td>Selected for pilot.</td>
</tr>
<tr>
<td>B. DynamoDB + Streams + EventBridge</td>
<td>API Gateway + Lambda + DynamoDB</td>
<td>Use conditional writes for idempotency; store transfer and event items; publish via Streams→Lambda; dedupe at consumers.</td>
<td>Pay-per-use; very low cost at 1k tx/day; scales automatically; no connections.</td>
<td>Outbox shifts to at-least-once via Streams; must implement idempotent publisher and consumer dedupe; relational queries harder.</td>
<td>Viable low-cost alternative if we accept at-least-once with dedupe and keep schema simple.</td>
</tr>
<tr>
<td>C. EC2 or Lightsail + Postgres</td>
<td>Nginx + app on EC2/Lightsail + Postgres</td>
<td>Traditional deployment; identical semantics to SDD.</td>
<td>Simple mental model; predictable performance; cheapest if always-on and tiny.</td>
<td>Ops overhead (patching, scaling); less elastic; need HA for SLOs.</td>
<td>Acceptable for a throwaway pilot; less aligned with serverless strategy.</td>
</tr>
</tbody>
</table>
<p>Notes on Option B (DynamoDB)
- Idempotency: <code>PutItem</code> with <code>ConditionExpression attribute_not_exists(pk)</code> using <code>(tenantId, idempotencyKey, bodyHash)</code> item; TTL attribute for GC.
- Transfers/events: single-table design with <code>PK=TRANSFER#&lt;transferId&gt;</code>, <code>SK=STATE#...</code> and <code>SK=EVENT#...</code>; <code>transfer_events</code> uniqueness via <code>ConditionExpression</code> on <code>(transferId,type)</code>.
- Outbox: write event items; use DynamoDB Streams to trigger publisher Lambda; publisher writes to EventBridge; consumers dedupe by <code>eventId</code> and <code>(transferId,type)</code>.
- Read model: <code>GET /transfers/:id</code> via <code>Query PK=TRANSFER#...</code> ordered by <code>SK</code>.</p>
<p>Cost posture (directional, not a quote)
- Requests/day ~2k → API Gateway/Lambda costs are negligible; DynamoDB RU/WU minimal at pilot scale; Aurora Serverless has a small baseline cost due to min ACUs; EC2/Lightsail cheapest if always-on but adds ops overhead.</p>
<p>Recommendation for pilot
- Selected: Option A (Aurora Serverless v2 + RDS Proxy). Keep the SDD’s OLTP schema and transactional outbox as-is.
- Option B remains a fallback if costs require further reduction; keep abstraction boundaries to allow future swap.</p>
<p>Pilot deployment (selected Option A)
<pre class="mermaid"><code>flowchart LR
  Client --&gt; APIGW[API Gateway]
  APIGW --&gt; LAPI[Lambda CTS API]
  LAPI --&gt; RDS[(Aurora Serverless v2 via RDS Proxy)]
  LAPI --&gt; CW[CloudWatch/X-Ray]
  subgraph Outbox
    LWORK[Lambda Outbox Worker]
    EBus[EventBridge events.transfers.*]
  end
  RDS &lt;-- poll PENDING --&gt; LWORK
  LWORK --&gt; EBus</code></pre></p>
<p>Pilot configuration (Option A)
- Aurora Serverless v2 PostgreSQL 15; min ACU 0.5–1, max ACU 4; Multi-AZ on.
- RDS Proxy for Lambda connections; IAM auth or Secrets Manager rotation (90 days).
- Outbox Worker Lambda: runs on a 15–30s schedule; batch size 500; exponential backoff; idempotent publish to EventBridge (partition key <code>transferId</code>).
- VPC: Lambdas in private subnets with NAT; security groups restrict DB access.
- Observability: CloudWatch metrics/logs, X-Ray traces; alarms per SLOs.
- Migrations: Flyway/Liquibase executed via CI job before deploy.</p>
<hr />
<h3 id="authoritative-input-spec">Authoritative Input Spec<a class="headerlink" href="#authoritative-input-spec" title="Permanent link">&para;</a></h3>
<p>As provided. Preserved verbatim for traceability.</p>
<div class="highlight"><pre><span></span><code>[BEGIN INPUT SPEC]
# Canonical Transfer Service (CTS)

The **Canonical Transfer Service (CTS)** is the **front door and conductor** of Storo.  
It provides a single API for creating and managing transfers, normalizes requests into a canonical format, enforces idempotency, screens entities, routes transfers, and emits domain events.

---

## 🎯 Purpose

- Provide a **unified API** for all transfers (payments, payouts, pushes, pulls).  
- Normalize requests into a **canonical model** independent of rail quirks.  
- Act as the **orchestrator** for transfer lifecycle events.  
- Enforce **idempotency** across client submissions.  
- Ensure **compliance screening** before any transfer reaches a rail.  
- Emit **domain events** (`transfers.*`) so all state changes are visible and auditable.  

---

## 🛠 Responsibilities

- **Accept API requests** (`POST /transfers`, `GET /transfers/:id`).  
- **Deduplicate** requests using idempotency keys and hashes.  
- **Validate and normalize** inputs into the canonical transfer schema.  
- **Pre-screen** payer and payee using the Compliance service.  
- **Route** transfers through the Directory &amp; Routing service.  
- **Emit events** (`initiated`, `submitted.&lt;rail&gt;`) via the outbox.  
- **Track lifecycle state** for each transfer.  

---

## 🔌 Interfaces

### API Endpoints
- `POST /transfers`  
  - Create a new transfer.  
  - Requires `Idempotency-Key` header.  
  - Body: canonical transfer schema.  

- `GET /transfers/:id`  
  - Fetch transfer details including timeline of events.  

&gt; See Specs: [../20-specs/api-canonical-transfer.md](../20-specs/api-canonical-transfer.md)

### Event Topics
- Emits (envelope `v=1`):
  - `transfers.initiated`
  - `transfers.submitted.&lt;rail&gt;`
- Consumes:
  - `transfers.accepted`
  - `transfers.settled`
  - `transfers.returned`
  - `transfers.failed`

---

### Admin Endpoints (via Platform/Base)
- `GET /live`, `GET /ready`, `GET /metrics`, `GET /version` provided by Platform/Base and adopted by CTS.


## 🗄 Data Model

**Table: `transfers`**  
- `transferId` (PK)  
- `tenantId`  
- `payer`, `payee` (JSON)  
- `amount { value, currency }`  
- `rail`  
- `intent` (AUTH | CAPTURE | PUSH | PULL)  
- `externalRef`  
- `state` (INITIATED, SUBMITTED, …)  
- `createdAt`, `updatedAt`  

**Table: `transfer_events`**  
- `eventId`  
- `transferId` (FK)  
- `type`  
- `payload` (JSON)  
- `occurredAt`  

**Table: `outbox_transfers`**  
- Standard outbox pattern for exactly-once event publishing.  
  - Columns: `id`, `eventType`, `payload`, `state` (PENDING|SENT|FAILED), `createdAt`, `attempts`, `lastError?`

---

## 📐 Diagram

### Sequence: Happy Path (USDC transfer)

```mermaid
sequenceDiagram
  participant Client
  participant CTS as Canonical Transfer Service
  participant CS as Compliance
  participant DR as Directory
  participant GW as Rail Gateway (USDC)

  Client-&gt;&gt;CTS: POST /transfers (idempotency-key)
  CTS-&gt;&gt;CTS: Deduplicate &amp; normalize
  CTS-&gt;&gt;CS: Pre-screen payer/payee
  CS--&gt;&gt;CTS: Allow
  CTS-&gt;&gt;DR: Lookup route
  DR--&gt;&gt;CTS: Rail endpoint
  CTS-&gt;&gt;CTS: Persist transfer, state=SUBMITTED
  CTS-&gt;&gt;GW: Event transfers.submitted.usdc
  GW--&gt;&gt;CTS: Event transfers.accepted
  GW--&gt;&gt;CTS: Event transfers.settled
  CTS-&gt;&gt;Client: 200 OK { state: SETTLED }
</code></pre></div>
<hr />
<h2 id="state-machine">🔄 State Machine<a class="headerlink" href="#state-machine" title="Permanent link">&para;</a></h2>
<p>See transfer lifecycle diagram: <a href="../../30-diagrams/lifecycle-state/">../30-diagrams/lifecycle-state.md</a></p>
<h2 id="failure-modes-retries">🚨 Failure Modes &amp; Retries<a class="headerlink" href="#failure-modes-retries" title="Permanent link">&para;</a></h2>
<ul>
<li>Duplicate submission → return existing transfer (idempotent).  </li>
<li>Compliance = deny → return 422 EntityDenied.  </li>
<li>Directory lookup fails → return 502 RoutingUnavailable.  </li>
<li>Rail submission fails → state = FAILED, event emitted.  </li>
<li>Outbox publish failure → retry with exponential backoff.  </li>
<li>Consumers must dedupe by <code>eventId</code> (and <code>(transferId,type)</code> uniqueness for lifecycle).  </li>
</ul>
<hr />
<h2 id="observability">📊 Observability<a class="headerlink" href="#observability" title="Permanent link">&para;</a></h2>
<p><strong>Metrics</strong><br />
- API latency (p95, p99).<br />
- Idempotency collision rate.<br />
- Compliance check latency.<br />
- Transfers by state (submitted, settled, returned).  </p>
<p><strong>Logs</strong><br />
- Structured JSON with transferId, tenantId, eventId.  </p>
<p><strong>Tracing</strong><br />
- Propagate request IDs through to gateways and ledger.  </p>
<hr />
<h2 id="security">🔐 Security<a class="headerlink" href="#security" title="Permanent link">&para;</a></h2>
<ul>
<li>API authentication with tenant-level keys/tokens.  </li>
<li>All PII (payer/payee) encrypted at rest.  </li>
<li>Access to transfer data restricted by tenant scope.  </li>
<li>Logs redact sensitive fields (names, IDs, PANs).  </li>
</ul>
<hr />
<h2 id="runbooks">📘 Runbooks<a class="headerlink" href="#runbooks" title="Permanent link">&para;</a></h2>
<ul>
<li>If API latency spikes → check compliance and directory service dependencies.  </li>
<li>If transfers stuck in SUBMITTED → inspect gateway outbox and retry queue.  </li>
<li>If idempotency collisions increase → confirm client integration is using stable Idempotency-Key.  </li>
<li>If compliance service is unreachable → all submissions should fail-safe (no unscreened transfers).<br />
[END INPUT SPEC]
```</li>
</ul>
<hr />
<h3 id="open-questions-next-decisions">Open Questions &amp; Next Decisions<a class="headerlink" href="#open-questions-next-decisions" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Finalize SNS/SQS FIFO IaC and naming conventions for pilot.</li>
<li>[ ] Confirm Compliance sign-off on retention durations (events/logs).</li>
<li>[ ] Define per-currency min/max and fee fields for all pilot currencies.</li>
<li>[ ] Approve tenant default quotas and the override approval process.</li>
<li>[ ] Validate canonicalization test vectors with integrators.</li>
<li>[ ] Decide archive format and encryption for long-term event storage.</li>
<li>[ ] Confirm Directory <code>route.updated</code> event shape and cache key.</li>
<li>[ ] Choose replay authorization workflow and audit approvals.</li>
<li>[ ] Set trace sampling defaults per environment (dev/stage/prod).</li>
</ul>
<h3 id="next-iteration-plan-2-weeks">Next Iteration Plan (2 weeks)<a class="headerlink" href="#next-iteration-plan-2-weeks" title="Permanent link">&para;</a></h3>
<ul>
<li>Week 1</li>
<li>Engineers: A (API/Idempotency), B (Outbox/Worker), C (Integrations)</li>
<li>Tasks: Scaffold service; implement POST/GET; idempotency table; outbox write; basic publish; compliance+directory clients with timeouts; metrics+tracing.</li>
<li>Exit criteria: POST happy path to mock services; events visible on test topic; p95 &lt; 500ms without external calls.</li>
<li>Week 2</li>
<li>Engineers: A (State/Projections), B (DLQ/Backoff), C (Load/Chaos)</li>
<li>Tasks: State updates from inbound events; projections for GET; backoff+DLQ; rate limiting; alert rules; load tests at 200 TPS; chaos tests.</li>
<li>Exit criteria: All sequences pass in CI; alerts in place; docs updated; demo end-to-end flow.</li>
</ul>
<hr />
<h3 id="decisions-ready-to-adopt">Decisions (ready to adopt)<a class="headerlink" href="#decisions-ready-to-adopt" title="Permanent link">&para;</a></h3>
<p>1) Canonical schema ownership &amp; versioning cadence
- Decision: Platform/Architecture owns the canonical schema; changes via Schema Working Group.
- Versioning: SemVer on canonical model; header <code>X-Canonical-Version</code> and <code>envelope.v</code>.
- Cadence: Minor every 2 weeks as needed; Major with quarterly planning.
- Mechanics: JSON Schema in <code>schemas/canonical-transfer/v{n}</code>; RFC + contract tests.</p>
<p>2) Per-tenant quotas &amp; default limits
- Decision: Token-bucket per tenant at API gateway + app layer.
- Defaults: Write 2 TPS sustained (burst 20 for 60s); Read 10 TPS sustained (burst 50 for 60s); Daily cap 10k transfers/tenant.
- Behavior: 429 with Retry-After when exhausted; emit <code>quota.exceeded</code>.</p>
<p>3) DB technology &amp; JSONB usage
- Decision: Aurora PostgreSQL v2 with JSONB for payer/payee and envelopes; relational columns for hot filters.
- Indexes: <code>(tenantId, createdAt)</code>, PK <code>(transferId)</code>, partial unique <code>(tenantId, idempotencyKey, bodyHash)</code> for 36h window; GIN only when needed.</p>
<p>4) Event bus &amp; partition strategy
- Decision: SNS FIFO with SQS FIFO subscribers; <code>MessageGroupId=transferId</code>, <code>MessageDeduplicationId=eventId</code>.</p>
<p>5) Envelope schema registry &amp; tooling
- Decision: Git-based JSON Schema registry under <code>schemas/</code> with CI validation.</p>
<p>6) Settlement sync response policy
- Decision: Never return SETTLED synchronously; first response 201/200 with <code>state=SUBMITTED</code>.</p>
<p>7) DLQ storage &amp; triage workflow
- Decision: Outbox publisher DLQ → SQS standard (14 days); consumer DLQs per SQS FIFO; re-drive Lambda with idempotency.</p>
<p>8) Retention durations (pending Compliance)
- Defaults: Events 7y (WORM after 90d), Transfers 2y hot then Glacier Deep Archive, Idempotency 36h, Logs 30d, Metrics 15m.</p>
<p>9) Directory cache invalidation hooks
- Decision: Directory publishes <code>directory.route.updated</code>; CTS invalidates/pre-warms cache.</p>
<p>10) Trace sampling rate &amp; PII redaction
- Decision: Head-based sampling (10% default; 100% for 5xx or p95 breaches); PII allowlist in logs/traces.</p>
<hr />
<h3 id="implementation-map-whowhatwhen">Implementation map (who/what/when)<a class="headerlink" href="#implementation-map-whowhatwhen" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Item</th>
<th>Owner</th>
<th>Artifacts</th>
<th>Exit Criteria</th>
</tr>
</thead>
<tbody>
<tr>
<td>Schema governance</td>
<td>Platform Lead</td>
<td>ADR-001, <code>schemas/canonical-transfer/</code></td>
<td>CI rejects non-compliant events; schema published</td>
</tr>
<tr>
<td>Quotas &amp; limits</td>
<td>API Eng</td>
<td>gateway config + middleware</td>
<td>429s with Retry-After; per-tenant metrics</td>
</tr>
<tr>
<td>Aurora Pg + JSONB</td>
<td>DB Eng</td>
<td>ADR-003, migrations</td>
<td>Tables + indexes live; RDS Proxy wired; load test passes</td>
</tr>
<tr>
<td>SNS/SQS FIFO bus</td>
<td>Platform Eng</td>
<td>ADR-004, IaC</td>
<td>Topic + queues live; ordering verified</td>
</tr>
<tr>
<td>JSON schema registry</td>
<td>App Eng</td>
<td>ADR-005, CI rules</td>
<td>All events validated in CI + prod (shadow)</td>
</tr>
<tr>
<td>Async-only settlement</td>
<td>App Eng</td>
<td>ADR-006, API docs</td>
<td>POST always returns SUBMITTED</td>
</tr>
<tr>
<td>DLQ &amp; re-drive</td>
<td>SRE</td>
<td>ADR-007, runbooks, Lambda</td>
<td>Re-drive tool works; alarms wired</td>
</tr>
<tr>
<td>Retention policy</td>
<td>Compliance + SRE</td>
<td>ADR-008, lifecycle rules</td>
<td>Glacier policies in place; PII separation verified</td>
</tr>
<tr>
<td>Route invalidation</td>
<td>Directory + App Eng</td>
<td>ADR-009</td>
<td>Cache flushes on update event; TTLs enforced</td>
</tr>
<tr>
<td>Tracing + redaction</td>
<td>SRE</td>
<td>ADR-010, log filters</td>
<td>10% sampling, error boost, PII allowlist verified</td>
</tr>
</tbody>
</table>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.instant", "navigation.tracking", "content.code.copy", "content.action.edit", "toc.integrate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
        <script src="../../javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>